# Configuración de Amazon S3 para Active Storage

Aquí te detallo los pasos para configurar un bucket de S3 y preparar tu aplicación Rails para usarlo:

## 1\. Crear el Bucket de S3

Vamos a crear un bucket específico para tu proyecto.

1. **Inicia sesión en la Consola de AWS** con tu usuario IAM recién creado (o con tu usuario administrativo si aún no has configurado el acceso a la consola para el usuario IAM).
2. En la barra de búsqueda, escribe **"S3"** y selecciona el servicio.
3. Haz clic en el botón **"Create bucket"** (Crear bucket).
4. **Configura los detalles del bucket:**
   - **AWS Region:** Elige la región de AWS que esté más cerca de tus usuarios o donde planeas desplegar tu EC2 y RDS. Por ejemplo, `us-east-1` (N. Virginia) o `sa-east-1` (São Paulo) si estás en Latinoamérica. Es importante que esta región sea la misma que usarás para EC2 y RDS para reducir la latencia.
   - **Bucket name:** El nombre del bucket debe ser **globalmente único** (no puede haber otro bucket con el mismo nombre en todo AWS). Te sugiero un nombre que incluya el nombre de tu proyecto y un identificador único, por ejemplo: `blogdepruebaaws-images-tuid`. Si tu nombre es "tu nombre", podría ser `blogdepruebaaws-images-tunombre`. Usa solo letras minúsculas, números y guiones.
   - **Object Ownership:** Deja la opción predeterminada **"ACLs disabled (recommended)"** con la opción **"Recommended"** seleccionada para que todos los objetos en el bucket sean propiedad del propietario de la cuenta.
   - **Block Public Access settings for this bucket:** Por defecto, S3 bloquea el acceso público para mayor seguridad. Para las imágenes de un blog que deben ser accesibles, **tendrás que desmarcar la opción "Block all public access"** para este bucket.
     - **¡Advertencia de Seguridad\!**: Al desmarcar esta opción, estás permitiendo que los objetos en este bucket (potencialmente tus imágenes) puedan ser accesibles públicamente. Es importante que entiendas las implicaciones. Para un blog, esto es a menudo necesario para que las imágenes se muestren en el sitio web.
     - Confirma que entiendes esto marcando la casilla de confirmación.
   - **Bucket Versioning:** Deja la opción predeterminada **"Disable"** por ahora (puedes habilitarlo más tarde si necesitas control de versiones de objetos).
   - **Default encryption:** Deja la opción predeterminada **"Server-side encryption with Amazon S3 managed keys (SSE-S3)"**.
   - Deja las demás opciones como están por defecto.
5. Haz clic en **"Create bucket"**.

## 2\. Configurar la Política de Bucket (Bucket Policy)

Aunque deshabilitamos el "Block Public Access", necesitamos una política de bucket para permitir que los objetos (imágenes) dentro del bucket sean leídos por cualquiera en internet.

1. En la lista de buckets, haz clic en el **nombre de tu nuevo bucket**.

2. Ve a la pestaña **"Permissions"** (Permisos).

3. En la sección **"Bucket policy"**, haz clic en **"Edit"** (Editar).

4. Pega la siguiente política de bucket. **Asegúrate de reemplazar `tu-nombre-de-bucket-unico` con el nombre exacto de tu bucket de S3.**

   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Principal": "*",
         "Action": "s3:GetObject",
         "Resource": "arn:aws:s3:::tu-nombre-de-bucket-unico/*"
       }
     ]
   }
   ```

5. Haz clic en **"Save changes"** (Guardar cambios).

   - Esta política permite a cualquier entidad (`"Principal": "*"`) realizar la acción `s3:GetObject` (leer objetos) en todos los objetos (`/*`) dentro de tu bucket.

## 3\. Configurar CORS (Cross-Origin Resource Sharing)

Para permitir que tu aplicación web (que se ejecutará en EC2) acceda a los recursos de S3, necesitas configurar las reglas CORS.

1. Mientras sigues en la pestaña **"Permissions"** de tu bucket, desplázate hacia abajo hasta la sección **"Cross-origin resource sharing (CORS)"**.

2. Haz clic en **"Edit"**.

3. Pega la siguiente configuración:

   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <CORSConfiguration xmlns="http://s3.amazonaws.com/doc/2006-03-01/">
   <CORSRule>
       <AllowedOrigin>*</AllowedOrigin>
       <AllowedMethod>GET</AllowedMethod>
       <AllowedMethod>POST</AllowedMethod>
       <AllowedMethod>PUT</AllowedMethod>
       <MaxAgeSeconds>3000</MaxAgeSeconds>
       <AllowedHeader>*</AllowedHeader>
   </CORSRule>
   </CORSConfiguration>
   ```

4. Haz clic en **"Save changes"**.

   - Esta configuración de CORS es bastante permisiva (`<AllowedOrigin>*</AllowedOrigin>`), permitiendo solicitudes desde cualquier origen. Para producción, podrías restringir `AllowedOrigin` a los dominios de tu aplicación.

## 4\. Configurar tu Aplicación Rails para Usar S3

Ahora que S3 está listo, vamos a configurar tu aplicación Ruby on Rails.

1. **Abre tu proyecto Rails** en tu editor de código.

2. Abre el `Gemfile` y añade la gema `aws-sdk-s3`. Esta gema es el SDK de AWS para Ruby y permite a tu aplicación interactuar con S3.

   ```ruby
   # Gemfile
   gem 'aws-sdk-s3', '~> 1.0' # O una versión compatible, consulta la documentación si es necesario
   ```

   - Guarda el archivo y ejecuta `bundle install`.

3. **Configura Active Storage para usar S3 en producción:**

   - Abre el archivo `config/environments/production.rb`.
   - Asegúrate de que `config.active_storage.service` esté configurado para `amazon`.
   - Debería verse algo así (verifica si ya existe esta línea y si no, añádela o modifícala):
     ```ruby
     # config/environments/production.rb
     config.active_storage.service = :amazon
     ```

4. **Configura las credenciales de S3:**

   - Abre el archivo `config/storage.yml`.
   - Bajo la sección `amazon`, configura tu bucket y región. **Reemplaza los marcadores de posición** con tus valores reales.
     ```yaml
     # config/storage.yml
     amazon:
       service: S3
       access_key_id: <%= ENV["AWS_ACCESS_KEY_ID"] %>
       secret_access_key: <%= ENV["AWS_SECRET_ACCESS_KEY"] %>
       region: tu-region-aws # Ejemplo: us-east-1
       bucket: tu-nombre-de-bucket-unico # Ejemplo: blogdepruebaaws-images-tunombre
     ```
   - **Nota importante:** Estamos usando `ENV["AWS_ACCESS_KEY_ID"]` y `ENV["AWS_SECRET_ACCESS_KEY"]`. Esto significa que NO debes poner tus credenciales directamente en este archivo. En su lugar, las estableceremos como variables de entorno en el servidor EC2 donde desplegaremos la aplicación (y en tu entorno de desarrollo para probar S3 localmente si lo deseas, pero ten cuidado con exponer credenciales).

## 5\. Probar Active Storage con S3 Localmente (Opcional, pero recomendado)

Para verificar que la configuración de S3 funciona antes de desplegar en EC2, puedes configurar tu entorno de desarrollo para usar S3:

1. **Crea un archivo `.env` en la raíz de tu proyecto** (asegúrate de que esté en tu `.gitignore` para no subirlo a tu repositorio público):

   ```
   # .env
   AWS_ACCESS_KEY_ID="tu_access_key_id_iam"
   AWS_SECRET_ACCESS_KEY="tu_secret_access_key_iam"
   ```

   - **¡ATENCIÓN\!** Nunca subas este archivo a Git. Añade `.env` a tu `.gitignore`.

2. Instala una gema como `dotenv-rails` para cargar estas variables de entorno en desarrollo:

   - Abre tu `Gemfile` y añade:
     ```ruby
     # Gemfile
     group :development, :test do
       gem 'dotenv-rails'
     end
     ```
   - Guarda y ejecuta `bundle install`.

3. **Configura Active Storage para usar S3 en desarrollo:**

   - Abre `config/environments/development.rb`.
   - Cambia `config.active_storage.service = :local` a:
     ```ruby
     # config/environments/development.rb
     config.active_storage.service = :amazon
     ```

4. Reinicia tu servidor Rails (`rails s`).

5. Intenta subir una imagen a un artículo desde tu aplicación local. Si todo está bien, la imagen debería aparecer en tu bucket de S3.
